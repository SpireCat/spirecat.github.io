---
layout: post
title:  "斗鱼直播平台弹幕及人气抓取及分析"
date:   2016-6-19 13:25
categories: WEB前端
permalink: /archivers/douyubarrage
---

# 0x00 声明

&#160; &#160; &#160; &#160;本文涉及的工作为本人（Sun Jian）在斗鱼官方提供的《斗鱼第三方开放平台API文档v2.1》以及《斗鱼弹幕服务器第三方接入协议v1.4.1》（包括所提供的code demo）【版权声明：Copyright (C) 武汉斗鱼网络科技有限公司（2016）. All Rights Reserved.
】基础上所开发、修改和更新的第三方平台，本人无意利用此第三方平台获利且无意损害斗鱼平台任何利益。

&#160; &#160; &#160; &#160;此外，本文引述知乎话题“如何获取斗鱼直播间的弹幕信息？”中部分用户的回答，其权益归原作者或所属机构、团体所有，但本人对本文享有著作权。如转载引述，请务必申明出处并告知本人。

# 0x01 确定弹幕抓取思路

&#160; &#160; &#160; &#160;众所周知，如果想要获取网页上的内容，编写网页爬虫的手段是不二之选。通常情况下，在编写爬虫时，我们需要注意request的消息头和消息报文内容就可以了。当然，当遇到存在反爬虫机制或是反跨站机制的网站时，我们需要提前登陆获取验证以及token等数据。并且由于HTTP协议的请求-响应机制，我们很容易通过响应状态码和响应信息判断请求到的信息的有效性。

&#160; &#160; &#160; &#160;但是对于斗鱼弹幕这种实时传输的数据而言，显然通过这种网络爬虫是很难获取到的。（斗鱼弹幕与Bilibili的弹幕形式不同，Bilibili的弹幕是静态的且非实时的。）这个时候自然会想到socket通信，这是解决实时数据传输的一个好办法。这里又会遇见问题...如果使用socket方法，是HTML5 Web Socket还是Adobe Flash Web Socket呢，还是其他的一些通信机制？

&#160; &#160; &#160; &#160;其实很简单的方法就可以帮助我们解决这个问题。用Chrome浏览器任意打开一个正在直播的房间，F12打开开发者工具，在NetWork选项下利用Filter过滤标签WS(WebSocket)，即可查看有没有与服务器之间的WebScoket类型的数据通信。然而...是没有的...如下图所示：

<p><img src="/img/dybarr0.png" /></p>

&#160; &#160; &#160; &#160;于是我们把目标锁定在了Flash socket身上，我们期待能在这里找到获取弹幕的执行逻辑。万般无奈下，只有选择Wireshark对数据进行抓包分析，尽管在依此得到答案之前我一直鄙视这是一个烂方法。但是...啪啪啪。如下图所示：

<p><img src="/img/dybarr1.png" /></p>

&#160; &#160; &#160; &#160;当看到第四个包（前三个包为建立Socket信道的三次握手）中的[policy-file-request/]信息时，我们可以确定了斗鱼弹幕使用的是Flash Socket。因为当 Flash 连接服务器需要安全策略验证时，会向服务端发送特定的字符串信息[policy-file-request/] 。然后我们接着看剩下的包...[多图预警]

<p><img src="/img/dybarr2.png" /></p>
<p><img src="/img/dybarr3.png" /></p>
<p><img src="/img/dybarr4.png" /></p>
<p><img src="/img/dybarr5.png" /></p>
<p><img src="/img/dybarr6.png" /></p>

&#160; &#160; &#160; &#160;当我们静下心来看完这些包重点的内容后我们就能猜解出斗鱼前端与弹幕服务器的通信规则：

*****

+ 通过TCP协议连接到弹幕服务器(依据指定的IP和端口)

+ 客户端向弹幕服务器发送登录请求，登录弹幕服务器

+ 弹幕服务器收到客户端登录请求并完成登录后，返回登录成功消息给客户端

+ 客户端收到登录成功消息后发送进入弹幕分组请求给弹幕服务器

+ 弹幕服务器接受到客户端弹幕分组请求后将客户端添加到请求指定的弹幕分组中 

+ 客户端接受服务器传来的指定分组的弹幕消息

*****

&#160; &#160; &#160; &#160;至此，对于抓取弹幕的套路我们基本可以掌握了，那就是...[编写request挨个模拟这些消息做一个伪客户端就好啦呵呵]

# 0x02 确定人气抓取思路

&#160; &#160; &#160; &#160;如果你是经常用校园网看直播...并且你们校园网质量还很差（用网高峰时）...并且你还是一个龟毛处女座...的话，你会很熟悉一个细节——当直播间页面加载完成之后，房间的人气和体重等信息往往还未显示并处于正在加载的状态，并且每45s更新一次。

&#160; &#160; &#160; &#160;看了源码找不到对应的用来刷新数据的JS...开着F12,也只能每次盯着这个数据神奇地刷新...难道是ngix缓存...那又该怎么做...

&#160; &#160; &#160; &#160;于是...我们在这一步遇到了麻烦...

# 0x03 官方给的帮助

&#160; &#160; &#160; &#160;实际上，在我基本摸清思路的时候才刚刚发现斗鱼在开发者论坛上给出了第三方的开发协议，也就是开篇提到的那两份协议，协议里面的内容印证了我们之前的判断，并提供了更多的帮助：

*****

+ 斗鱼官方分别给出了第三方api的弹幕服务器和房间信息地址(JSON形式数据)

+ 在官方的文档中注明了keeplive心跳包的消息格式，为了对Socket通信进行“保活”

+ 官方给出了c++和java版本的code demo

*****

&#160; &#160; &#160; &#160;坦白来讲，这些帮助使我能够快速得完成预期的工作。

# 0x04 extra目的

&#160; &#160; &#160; &#160;这里需要进行补充说明的是，开发这个第三方平台还有一部分用意是为了分析斗鱼直播间内人气增长与弹幕频率增长时间的关系。

&#160; &#160; &#160; &#160;经过一次心跳时间（45s），在这个时间段结束的时刻t，设这段时间内弹幕数量为b，较之前时间段内的弹幕数量的变化量为▲b，人气值为o。于是，我们令f(t)=b，g(t)=o，h(t)=▲b。在通常意义下，在一段时间内，如果房间内人数增长，对应的单位时间内弹幕数量的弹幕数量也会增长。也就是说单位时间内弹幕频率的增长与房间人数的增长是同步协调的。也就是说h'(t)与f'(t)应具有一致性，并且，在忽略精度的前提下我们可以近似的看作g''(t)与f'(t)具有一致性。

&#160; &#160; &#160; &#160;坦言这个模型有很多纰漏，但作为一份额外工作，权当作了乐趣。

&#160; &#160; &#160; &#160;所以，在此第三方平台中，程序将统计每次心跳包发送时计次、该时间点的人气数据以及该事件间隔内的弹幕数量如下所示：

<p><img src="/img/dybarr7.png" /></p>

# 0x05 源码

&#160; &#160; &#160; &#160;本项目的源码已经托管至Github上，[传送门](https://github.com/SpireCat/Get_Douyu_Danmu/tree/master)。

# 0x06 效果展示

&#160; &#160; &#160; &#160;弹幕抓取：

<p><img src="/img/dybarr8.png" /></p>

&#160; &#160; &#160; &#160;为了更加直观的展示人气和弹幕数量与时间的关系，我写了一个利用matplotlab库的Python脚本来对数据折线图进行图形化展示，如下两图所示（注意纵坐标标识）：

<p><img src="/img/dybarr9.png" /></p>

<p><img src="/img/dybarr10.png" /></p>

&#160; &#160; &#160; &#160;然而，很遗憾的是，为了撰写本文所抓取的50组示例数据的展示结果并没有显示出预期的效果，可能的原因有三：1.模型误差过大，导致图像问题出现；2.数据数量过小，不具有普遍性；3.选取的直播时间段内，直播数据的变化出现突然变动（如“火箭”等礼物的出现）。

&#160; &#160; &#160; &#160;至此，主体工作初步完成。

# 0x07 TODO

&#160; &#160; &#160; &#160;这是接下来准备做的两个工作(如果我会继续更这个项目23333)：

+ 尝试不依赖官方提供的第三方API获取直播间人气信息，理清运行逻辑。

+ 尝试对Android端APK进行反编译，分析源码获得更多信息和开发思路。

# 0x08 后记

&#160; &#160; &#160; &#160;本身自己没有下定决心研究斗鱼弹幕的相关问题，只是有一些兴趣。然而最近在从头系统的学习Android源码的规程中一波三折，屡屡受挫，所以才决定换换口味着手这个小项目。

&#160; &#160; &#160; &#160;很尴尬自己前段时间身体和精神的状态都不是很好，所以在平常生活与人相处以及处理这个项目时的心态都不是很好。在这里也要和最近被我有意无意冒犯伤害的人说一声抱歉，如果你们可以看到。也感谢身边一直包容自己的人。

&#160; &#160; &#160; &#160;写代码是一段越走越长的路，最近的危机感也是颇有加重，好在现在可以静下心来做些事情了。