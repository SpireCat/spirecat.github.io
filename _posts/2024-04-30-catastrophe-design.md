---
layout: post
title:  "如何设计一个错误的方案"
date:   2024-04-30 00:05:25 +0900
category: "生活随想"
---

最近两年一直在部门中担任基础框架部分的设计工作，新年伊始又开始在新的岗位承担职责。想想有必要为过去短短2年的设计生涯做一次小小的打结，想讲的很多很松散，还是从一个具体的例子入手，分享下自己犯过的一个设计错误。

部门整体在做的是一个微服务架构的低代码平台A，这个概念应该已经在互联网上出现了很长一阵子了。例子中要设计的方案是要能够把底层服务G中的用户数据同步到本系统中来，以解决平台A对用户暴露的用户模型DSL查询能力。

这个目标听起来本身就值得质疑，既然已经微服务化那么G服务应该可以直接对平台A暴露查询能力。但由于系统D本身对低代码概念的屏蔽、服务G难以完全支持A系统的全部复杂查询场景以及不同的开发团队协同问题，直接查询G这个看似最合理的方式首先被“毙掉”了。

![](/public/images/2024-04-29-framework.png)

跨系统的数据同步是一件并不简单的事情，有基本软件开发经验的人员一般都会关注这些点：

* 一致性：系统之间的数据应保持一致；
* 实时性：系统之间的数据延迟应尽量小，小到在业务场景下完全可以不Care；
* 可靠性：系统之间的同步能力不会因为升级、网络波动或短暂的数据查询失败导致故障。

此外，根据不同业务系统的诉求，可能还要支持其他能力：

* 数据变更监听：对于指定数据的变化能够触发某些预埋逻辑的监听；
* 数据变更事件广播：对于指定数据的变化进行广播通知，让有“需求”的模块无门槛接入。

这些对我来说并不困难，我很快拿出了我的解决方案。

![](/public/images/2024-04-29-problem.png)

核心的设计理念并不复杂：

* 基于全量同步能力进行数据初始化与周期纠正；
* 基于MQ实现的增量同步能力进行数据的及时更新；
* 基于内部服务之间的消息推送（也是基于MQ）进行事件通知。

但功能上线后并不如我所料想的那样稳定，很快这个设计就暴露除了它的局限性：

1. 由于原始数据与副本数据是在不同系统中使用的，自然会有很多差异化字段的存储诉求，而我并没有提前预留这些扩展位，A系统后续的很多定制字段诉求都被迫搁置了；
2. 原有直接面向G的部分查询能力仍然被保留（简单查询），导致后续很多查询方式变得不再单一，后来的很多瞬间我很后悔没有用这个模块来收编这些查询诉求；
3. 面向平台A整个集群无差别的数据推送，导致了很多资源浪费，甚至是消息风暴。在最开始的设计中并没有考虑主动注册与依赖反转。

再后来，我又花了很多时间来补偿这些错误，但这个模块的局限性已经很明显了。

讲了这么多，那应该如何总结设计上的抽象问题呢？自我批判从来是最容易的：

* 缺乏前瞻性。我有时很不习惯设想一些基础模块现在、将来应该在这个系统中发挥怎样的作用。这可能和我的应试思维有关，热衷于解决给定的命题范围；
* 对边界不敏感。能够在构思中将一些抽象模块实例化，并且清晰地站在上帝视角判定他们之间的关系，确实也是我待改进的地方。
* 关于细节。尽管作为一个相对比较偏执的人，思维模式中缺乏对微观问题的耐心思考能力，正如我很讨厌铺开细节。

再换个角度讲这些缺陷。最近在读《埃隆·马斯克传》，用他所说的第一性原则来分析，在做这件事情时，我思考的第一性问题是同步数据，而不是为系统A提供一个稳定、可靠、灵活的用户查询能力。

<div align="center">![](/public/images/2024-04-29-musk.jpg)</div>>

最近的工作都很忙，后面的工作预计也会很忙，期待下次这样打结。